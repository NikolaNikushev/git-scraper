{"url":"https://api.github.com/repos/willmcgugan/rich/issues/286","repository_url":"https://api.github.com/repos/willmcgugan/rich","labels_url":"https://api.github.com/repos/willmcgugan/rich/issues/286/labels{/name}","comments_url":"https://api.github.com/repos/willmcgugan/rich/issues/286/comments","events_url":"https://api.github.com/repos/willmcgugan/rich/issues/286/events","html_url":"https://github.com/willmcgugan/rich/pull/286","id":702831841,"node_id":"MDExOlB1bGxSZXF1ZXN0NDg4MDQ0Njg4","number":286,"title":"Bump up the total number of `ProgressSample` items.","user":{"login":"tomchristie","id":647359,"node_id":"MDQ6VXNlcjY0NzM1OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/647359?v=4","gravatar_id":"","url":"https://api.github.com/users/tomchristie","html_url":"https://github.com/tomchristie","followers_url":"https://api.github.com/users/tomchristie/followers","following_url":"https://api.github.com/users/tomchristie/following{/other_user}","gists_url":"https://api.github.com/users/tomchristie/gists{/gist_id}","starred_url":"https://api.github.com/users/tomchristie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomchristie/subscriptions","organizations_url":"https://api.github.com/users/tomchristie/orgs","repos_url":"https://api.github.com/users/tomchristie/repos","events_url":"https://api.github.com/users/tomchristie/events{/privacy}","received_events_url":"https://api.github.com/users/tomchristie/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-09-16T14:49:31Z","updated_at":"2020-09-16T15:27:14Z","closed_at":"2020-09-16T15:27:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/willmcgugan/rich/pulls/286","html_url":"https://github.com/willmcgugan/rich/pull/286","diff_url":"https://github.com/willmcgugan/rich/pull/286.diff","patch_url":"https://github.com/willmcgugan/rich/pull/286.patch"},"body":"When working with `rich` download progress bars with `httpx` we were finding the transfer speed jumping around all over the place.\r\n\r\nFor example, this snippet...\r\n\r\n```python\r\nimport tempfile\r\nimport httpx\r\nimport rich.progress\r\n\r\nwith tempfile.NamedTemporaryFile() as download_file:\r\n    url = \"https://speed.hetzner.de/100MB.bin\"\r\n    with httpx.stream(\"GET\", url) as response:\r\n        total = int(response.headers[\"Content-Length\"])\r\n\r\n        with rich.progress.Progress(\r\n            \"[progress.percentage]{task.percentage:>3.0f}%\",\r\n            rich.progress.BarColumn(bar_width=None),\r\n            rich.progress.DownloadColumn(),\r\n            rich.progress.TransferSpeedColumn(),\r\n        ) as progress:\r\n            download_task = progress.add_task(\"Download\", total=total)\r\n            for chunk in response.iter_bytes():\r\n                download_file.write(chunk)\r\n                progress.update(download_task, completed=response.num_bytes_downloaded)\r\n```\r\n\r\nWas resulting in this...\r\n\r\n![rich-progress](https://user-images.githubusercontent.com/647359/93353577-00956500-f834-11ea-8a3b-18b3f4108206.gif)\r\n\r\nHave now narrowed down the cause:\r\n\r\nWhen calculating transfer speeds, `rich` stores a ProgressSample every time the progress is updated.\r\nIt then averages out the transfer speed based on the progress samples.\r\n\r\nThe maximum window size of samples that are used is currently set to 30 seconds, or 20 samples, whichever is smaller.\r\nThat \"maximum of 20 samples\" is actually pretty small. (For example reading chunks of 16KB at a download speed of 16MB/s will result in 1000 samples/second)\r\n\r\nThis PR changes that window size to be 30 seconds, or 1000 samples, whichever is smaller.\r\n\r\n## Type of changes\r\n\r\n- [ ] Bug fix\r\n- [ ] New feature\r\n- [ ] Documentation / docstrings\r\n- [ ] Tests\r\n- [x] Other - UX\r\n\r\n## Checklist\r\n\r\n- [ ] I've run the latest [black](https://github.com/psf/black) with default args on new code.\r\n- [ ] I've updated CHANGELOG.md and CONTRIBUTORS.md where appropriate.\r\n- [ ] I've added tests for new code.\r\n- [x] I accept that @willmcgugan may be pedantic in the code review.\r\n\r\n## Description\r\n\r\nPlease describe your changes here. If this fixes a bug, please link to the issue, if possible.\r\n","closed_by":{"login":"willmcgugan","id":554369,"node_id":"MDQ6VXNlcjU1NDM2OQ==","avatar_url":"https://avatars3.githubusercontent.com/u/554369?v=4","gravatar_id":"","url":"https://api.github.com/users/willmcgugan","html_url":"https://github.com/willmcgugan","followers_url":"https://api.github.com/users/willmcgugan/followers","following_url":"https://api.github.com/users/willmcgugan/following{/other_user}","gists_url":"https://api.github.com/users/willmcgugan/gists{/gist_id}","starred_url":"https://api.github.com/users/willmcgugan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/willmcgugan/subscriptions","organizations_url":"https://api.github.com/users/willmcgugan/orgs","repos_url":"https://api.github.com/users/willmcgugan/repos","events_url":"https://api.github.com/users/willmcgugan/events{/privacy}","received_events_url":"https://api.github.com/users/willmcgugan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}